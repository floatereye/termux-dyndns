#!/bin/sh

if [ -z "$PREFIX" ]; then
	PREFIX=PATH
fi

# Process command-line arguments
while [ "$#" -gt 0 ]; do
  case "$1" in
    --prefix=*)
      PREFIX="$(echo "$1" | cut -d'=' -f2)"
      ;;
    --help)
      echo "Usage: ./configure [--prefix=<install_path>]"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
  shift
done

# Check for pkg-config
if ! command -v pkg-config >/dev/null 2>&1; then
  echo "[ERROR] pkg-config is not installed. Please install it."
  exit 1
fi

# Check for libcurl and json-c
if ! pkg-config --exists libcurl json-c; then
  echo "[ERROR] Required libraries (libcurl, json-c) not found. Please install them."
  exit 1
fi

# Get compiler and linker flags
CFLAGS="$(pkg-config --cflags libcurl json-c) -Wall -O2"
LDFLAGS="$(pkg-config --libs libcurl json-c)"
CC=clang
TARGET=termux-ddns-freedns
SRC=${TARGET}.c

# Generate config.mk
cat > config.mk <<EOF
CC=$CC
CFLAGS=$CFLAGS
LDFLAGS=$LDFLAGS
TARGET=$TARGET
SRC=$SRC
PREFIX=$PREFIX
EOF

# Generate Makefile
cat > Makefile <<EOF
include config.mk

all: \$(TARGET)

\$(TARGET): \$(SRC)
	\$(CC) \$(CFLAGS) -o \$(TARGET) \$(SRC) \$(LDFLAGS)

clean:
	rm -f \$(TARGET)

install:
	install -m 755 \$(TARGET) \$(PREFIX)/bin/

uninstall:
	rm -f \$(PREFIX)/bin/\$(TARGET)
EOF

echo "Configuration successful. Makefile generated. Run 'make' to build."

